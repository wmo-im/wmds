<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WMDR I-ADOPT compliant variable builder</title>
  <style>
    #dropdowns { display: flex; gap: 20px; }
    .dropdown-container { display: flex; flex-direction: column; align-items: center; }
  </style>

  <!-- Load PapaParse as a global BEFORE your script -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
  <h1>Utility to create I-ADOPT compliant variable (=observed quantity, measurand) names</h1>
  <p>Author: joerg.klausen@meteoswiss.ch</p>
  <p>With lots of inspiration from Morgan Silverman, Gao Chen, Barbara Magagna, Kathi Schleidt, Anna Milan, and the whole TT-WIGOSMD and ET-ACDM teams.</p>
  <p>Last update: 2025-03-31</p>

  <h2>Build variable</h2>
  <h3>Pattern A: observed quantities in the gas phase and certain state variables.</h3>
  <p>It is recommended to start with the selection of the 'Context', followed by the 'object of interest (OoI), then the 'Property'</p>

  <div id="dropdowns"></div>
  <button onclick="generateResult()">Generate result</button>
  <button onclick="clearSelections()">Clear Selections</button>

  <h3>Result</h3>
  <pre id="output"></pre>
  <button onclick="downloadCSV()">Download CSV</button>

  <script>
    // ---- Config ----
    const sources = [
      "./iadopt/wmdr2-candidates/wmdr2_geometry.csv",
      "./iadopt/wmdr2-candidates/wmdr2_property.csv",
      "./iadopt/wmdr2-candidates/glue.csv",
      "./iadopt/wmdr2-candidates/wmdr2_object_of_interest.csv",
      "./iadopt/wmdr2-candidates/glue.csv",
      "./iadopt/wmdr2-candidates/wmdr2_matrix.csv",
      "./iadopt/wmdr2-candidates/glue.csv",
      "./iadopt/wmdr2-candidates/wmdr2_domain.csv",
    ];

    const dropdownNames = [
      "Geometry",
      "Property",
      "><",
      "Object of Interest",
      "><",
      "Matrix",
      "><",
      "Context",
    ];

    const keyColumn = "id";     // column to use as <option value=...>
    const valueColumn = "name"; // column to display in the dropdown

    // ---- State ----
    let selections = [];
    let selectedValues = [];
    let savedSelections = [];

    // ---- CSV fetch via Papa ----
    async function fetchCSV(url) {
      if (typeof Papa === "undefined") {
        console.error("PapaParse is not loaded.");
        throw new Error("PapaParse is not loaded.");
      }

      const response = await fetch(url);
      if (!response.ok) {
        console.error(`Failed to fetch ${url}:`, response.status, response.statusText);
        throw new Error(`Failed to fetch ${url}`);
      }
      const text = await response.text();

      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false
      });

      if (parsed.errors && parsed.errors.length) {
        console.warn(`PapaParse reported ${parsed.errors.length} error(s) for ${url}:`, parsed.errors.slice(0,3));
      }

      // Verify expected columns exist
      if (!parsed.meta.fields.includes(keyColumn) || !parsed.meta.fields.includes(valueColumn)) {
        console.error(`CSV ${url} is missing required columns: "${keyColumn}" and/or "${valueColumn}". Found:`, parsed.meta.fields);
        throw new Error(`Missing columns in ${url}`);
      }

      // Build options (prepend default)
      const options = [{ key: "0", value: "" }];
      for (const row of parsed.data) {
        // Skip totally empty rows (Papa may include them if header:true)
        if (row == null || (typeof row === "object" && Object.values(row).every(v => v === "" || v == null))) {
          continue;
        }
        options.push({
          key: String(row[keyColumn] ?? ""),
          value: String(row[valueColumn] ?? "")
        });
      }
      return options;
    }

    // ---- UI setup ----
    async function main() {
      try {
        const container = document.getElementById("dropdowns");
        container.innerHTML = "";

        for (let i = 0; i < sources.length; i++) {
          const options = await fetchCSV(sources[i]);

          const dropdownContainer = document.createElement("div");
          dropdownContainer.classList.add("dropdown-container");

          const label = document.createElement("label");
          label.textContent = dropdownNames[i];

          const select = document.createElement("select");
          select.dataset.index = i;
          select.innerHTML = options
            .map(opt => `<option value="${opt.key}">${opt.value}</option>`)
            .join("");

          select.addEventListener("change", updateSelection);

          dropdownContainer.appendChild(label);
          dropdownContainer.appendChild(select);
          container.appendChild(dropdownContainer);

          // initialize state
          selections[i] = "0";
          selectedValues[i] = "";
        }
      } catch (err) {
        console.error("Initialization failed:", err);
        alert(`Initialization failed: ${err.message}`);
      }
    }

    function updateSelection(event) {
      const index = Number(event.target.dataset.index);
      selections[index] = event.target.value;
      selectedValues[index] = event.target.options[event.target.selectedIndex].text;
    }

    function computeId(keys) {
      let hash = 0;
      for (const key of keys) {
        const s = String(key);
        for (let i = 0; i < s.length; i++) {
          hash = (hash * 31 + s.charCodeAt(i)) % 100000;
        }
      }
      return hash.toString().padStart(5, "0");
    }

    function generateResult() {
      const id = computeId(selections);
      const csvRow = `"${selections.join(",")}"`;
      const valueRow = `"${selectedValues.join(" ")}"`;
      const entry = `ID: ${id}\nKeys: ${csvRow}\nValues: ${valueRow}`;
      document.getElementById("output").textContent += entry + "\n\n";
      savedSelections.push([id, csvRow, valueRow]);
      resetSelections();
    }

    function resetSelections() {
      document.querySelectorAll("select").forEach(select => (select.value = "0"));
      selections = selections.map(() => "0");
      selectedValues = selectedValues.map(() => "");
    }

    function clearSelections() {
      document.getElementById("output").textContent = "";
      savedSelections = [];
    }

    function downloadCSV() {
      const timestamp = new Date().toISOString().replace(/[-T:]/g, "").split(".")[0];
      const header = "ID,Keys,Values\n";
      const rows = savedSelections.map(row => row.join(",")).join("\n");
      const csvContent = header + rows;
      const blob = new Blob([csvContent], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `i-adopt-variables-${timestamp}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Wait for Papa (defer) + DOM, then run
    window.addEventListener("DOMContentLoaded", () => {
      if (typeof Papa === "undefined") {
        console.error("PapaParse is not available. Check the CDN script tag.");
        alert("PapaParse is not available. Check the CDN script tag.");
        return;
      }
      main();
    });
  </script>
</body>
</html>
