<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMDR I-ADOPT compliant variable builder</title>
    <style>
        #dropdowns {
            display: flex;
            gap: 20px;
        }
        .dropdown-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Utility to create I-ADOPT compliant variable (=observed quantity, measurand) names</h1>
    <p>Author: joerg.klausen@meteoswiss.ch</p>
    <p>With lots of inspiration from Morgan Silverman, Gao Chen, Barbara Magagna, Kathi Schleidt, Anna Milan, and the whole TT-WIGOSMD and ET-ACDM teams.</p>
    <p>Last update: 2025-03-31</p>

    <h2>Build variable</h2>
    <h3>Pattern A: observed quantities in the gas phase and certain state variables.</h3>
    <p>It is recommended to start with the selection of the 'Context', followed by the 'object of interest (OoI), then the 'Property'</p>
    <div id="dropdowns"></div>
    <button onclick="generateResult()">Generate result</button>
    <button onclick="clearSelections()">Clear Selections</button>
    <h3>Result</h3>
    <pre id="output"></pre>
    <button onclick="downloadCSV()">Download CSV</button>

    <script>
        const sources = [
            "./iadopt/wmdr2-candidates/wmdr2_geometry.csv",
            "/iadopt/wmdr2-candidates/wmdr2_property.csv",
            "iadopt/wmdr2-candidates/glue.csv",
            "./iadopt/wmdr2-candidates/wmdr2_object_of_interest.csv",
            "./iadopt/wmdr2-candidates/glue.csv",
            "./iadopt/wmdr2-candidates/wmdr2_matrix.csv",
            "./iadopt/wmdr2-candidates/glue.csv",
            "./iadopt/wmdr2-candidates/wmdr2_domain.csv",
        ]; // Add actual CSV file paths
        const dropdownNames = [
            "Geometry",
            "Property",
            "><",
            "Object of Interest",
            "><",
            "Matrix",
            "><",
            "Context",
        ]; // Names for dropdowns
        const keyColumn = "id"; // Specify the column name for keys
        const valueColumn = "name"; // Specify the column name for displayed values
        let selections = [];
        let selectedValues = [];
        let savedSelections = [];

        async function fetchCSV(url) {
            const response = await fetch(url);
            const text = await response.text();
            const rows = text.split("\n").map(row => row.trim()).filter(row => row);
            const headers = rows[0].split(",");
            const keyIndex = headers.indexOf(keyColumn);
            const valueIndex = headers.indexOf(valueColumn);
            let options = rows.slice(1).map(row => {
                const columns = row.split(",");
                return { key: columns[keyIndex], value: columns[valueIndex] };
            });
            options.unshift({ key: "0", value: "" }); // Default option
            return options;
        }

        async function main() {
            const container = document.getElementById("dropdowns");
            container.innerHTML = ""; // Clear previous dropdowns
            for (let i = 0; i < sources.length; i++) {
                const options = await fetchCSV(sources[i]);
                const dropdownContainer = document.createElement("div");
                dropdownContainer.classList.add("dropdown-container");

                const label = document.createElement("label");
                label.textContent = dropdownNames[i];

                const select = document.createElement("select");
                select.dataset.index = i;
                select.innerHTML = options.map(opt => `<option value="${opt.key}">${opt.value}</option>`).join("\n");
                select.addEventListener("change", updateSelection);

                dropdownContainer.appendChild(label);
                dropdownContainer.appendChild(select);
                container.appendChild(dropdownContainer);
                selections[i] = "0";
                selectedValues[i] = "";
            }
        }

        function updateSelection(event) {
            const index = event.target.dataset.index;
            selections[index] = event.target.value;
            selectedValues[index] = event.target.options[event.target.selectedIndex].text;
        }

        function computeId(keys) {
            let hash = 0;
            for (let key of keys) {
                for (let i = 0; i < key.length; i++) {
                    hash = (hash * 31 + key.charCodeAt(i)) % 100000;
                }
            }
            return hash.toString().padStart(5, '0');
        }

        function generateResult() {
            const id = computeId(selections);
            const csvRow = `"${selections.join(",")}"`;
            const valueRow = `"${selectedValues.join(" ")}"`;
            const entry = `ID: ${id}\nKeys: ${csvRow}\nValues: ${valueRow}`;
            document.getElementById("output").textContent += entry + "\n\n";
            savedSelections.push([id, csvRow, valueRow]);
            resetSelections();
        }

        function resetSelections() {
            const selects = document.querySelectorAll("select");
            selects.forEach(select => select.value = "0");
            selections = selections.map(() => "0");
            selectedValues = selectedValues.map(() => "Select an option");
        }

        function clearSelections() {
            document.getElementById("output").textContent = "";
            savedSelections = [];
        }

        function downloadCSV() {
            const timestamp = new Date().toISOString().replace(/[-T:]/g, "").split(".")[0];
            let csvContent = "ID,Keys,Values\n" + savedSelections.map(row => row.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `i-adopt-variables-${timestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        main();
    </script>
</body>
</html>
